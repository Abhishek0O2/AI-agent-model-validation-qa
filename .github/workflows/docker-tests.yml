name: Docker-based Model Tests

# Manual trigger only - run from GitHub Actions UI
on:
  workflow_dispatch:
    inputs:
      test_marker:
        description: 'Pytest marker to run (e.g., p0, p1, p2, or leave empty for all)'
        required: false
        default: ''

jobs:
  docker-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        run: docker compose build

      - name: Start mock server
        run: docker compose up -d mock-server

      - name: Wait for mock server to be ready
        run: |
          echo "Waiting for mock server to start..."
          sleep 5
          docker compose logs mock-server

      - name: Run tests in Docker
        run: |
          if [ -z "${{ github.event.inputs.test_marker }}" ]; then
            docker compose run --rm tests pytest -v --html=reports/pytest_report.html --self-contained-html
          else
            docker compose run --rm tests pytest -v -m ${{ github.event.inputs.test_marker }} --html=reports/pytest_report.html --self-contained-html
          fi

      - name: Display test logs
        if: always()
        run: docker compose logs tests

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-test-reports
          path: reports/
          retention-days: 30

      - name: Stop services
        if: always()
        run: docker compose down
